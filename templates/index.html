<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FocusFlow - AI Task Scheduler</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Mulish:wght@200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script
      src="https://apis.google.com/js/api.js"
      onload="window.gapiLoaded = true; if (window.domReady) init();"
      async
      defer
    ></script>
    <script>
      window.__gapiLoadCount = 0;
      const gapiCheck = setInterval(() => {
        window.__gapiLoadCount++;
        if (typeof gapi !== "undefined") {
          clearInterval(gapiCheck);
          console.log("gapi loaded after", window.__gapiLoadCount * 100, "ms");
        } else if (window.__gapiLoadCount > 50) {
          clearInterval(gapiCheck);
          console.error("gapi failed to load after 5s");
        }
      }, 100);
    </script>

    <meta
      http-equiv="Content-Security-Policy"
      content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://apis.google.com https://accounts.google.com https://www.gstatic.com https://ssl.gstatic.com https://content.googleapis.com https://*.gstatic.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com;
  font-src 'self' https://fonts.gstatic.com;
  connect-src 'self' https://www.googleapis.com https://accounts.google.com https://content.googleapis.com https://www.gstatic.com https://oauth2.googleapis.com;
  frame-src 'self' https://accounts.google.com https://content.googleapis.com https://www.google.com https://www.gstatic.com;
  img-src 'self' data: https: blob:;
  worker-src 'self' blob:;
"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Mulish", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1em;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .sidebar {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        max-height: 85vh;
        overflow-y: auto;
      }

      .calendar-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .add-task-form {
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #4a5568;
        font-weight: 500;
      }

      input,
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
        width: 100%;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
      }

      .task-list {
        margin-top: 30px;
      }

      .task-item {
        background: #f7fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
      }

      .task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .task-name {
        font-weight: 600;
        color: #2d3748;
      }

      .task-deadline {
        font-size: 12px;
        color: #718096;
      }

      .task-progress {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }

      .progress-bar {
        flex: 1;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
        transition: width 0.3s;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .week-view {
        display: grid;
        grid-template-columns: 80px repeat(7, 1fr);
        gap: 10px;
      }

      .time-label {
        color: #718096;
        font-size: 12px;
        text-align: right;
        padding-right: 10px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }

      .day-column {
        border-left: 1px solid #e2e8f0;
        position: relative;
        min-height: 60px;
      }

      .day-header {
        font-weight: 600;
        color: #2d3748;
        text-align: center;
        padding: 10px;
        border-bottom: 2px solid #e2e8f0;
      }

      .time-slot {
        height: 60px;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
      }

      .scheduled-task {
        position: absolute;
        left: 2px;
        right: 2px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }

      .scheduled-task:hover {
        transform: scale(1.02);
      }

      .scheduled-task.in-progress {
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
      }

      .scheduled-task.completed {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      }

      .scheduled-task.external-event {
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        min-width: 300px;
        animation: slideIn 0.3s ease;
        display: none;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      .notification.show {
        display: block;
      }

      .notification-header {
        font-weight: 600;
        margin-bottom: 10px;
        color: #2d3748;
      }

      .notification-body {
        color: #4a5568;
        margin-bottom: 15px;
      }

      .notification-actions {
        display: flex;
        gap: 10px;
      }

      .notification-btn {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
      }

      .notification-btn.accept {
        background: #48bb78;
        color: white;
      }

      .notification-btn.decline {
        background: #fc8181;
        color: white;
      }

      .notification-btn.reschedule {
        background: #f6d365;
        color: #2d3748;
      }

      .stats-panel {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-top: 15px;
      }

      .stat-card {
        text-align: center;
        padding: 15px;
        background: #f7fafc;
        border-radius: 8px;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        color: #718096;
        font-size: 0.9em;
        margin-top: 5px;
      }

      .ai-suggestions {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }

      .ai-suggestions h3 {
        color: #92400e;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .suggestion-item {
        background: white;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .suggestion-item:hover {
        transform: translateX(5px);
      }

      .pomodoro-timer {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 15px;
        min-width: 180px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        z-index: 100;
      }

      .timer-display {
        font-size: 2.2em;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 10px;
      }

      .timer-label {
        font-size: 0.9em;
        color: #718096;
        margin-bottom: 15px;
      }

      .timer-controls {
        display: flex;
        gap: 10px;
      }

      .timer-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: transform 0.2s;
      }

      .timer-btn:hover {
        transform: scale(1.05);
      }

      .timer-btn.pause {
        background: #f6d365;
        color: #2d3748;
      }

      .timer-btn.resume {
        background: #48bb78;
        color: white;
      }

      .timer-btn.stop {
        background: #fc8181;
        color: white;
      }

      .deadline-indicator {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e53e3e;
        pointer-events: none;
        z-index: 20;
      }

      .deadline-label {
        position: absolute;
        top: -20px;
        background: #e53e3e;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        white-space: nowrap;
        transform: translateX(-50%);
      }

      .google-cal-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .google-btn {
        background: white;
        border: 2px solid #4285f4;
        color: #4285f4;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
      }

      .google-btn:hover {
        background: #4285f4;
        color: white;
      }

      @media (max-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéØ FocusFlow</h1>
        <p>AI-Powered Task Scheduling with Pomodoro Tracking</p>
        <button onclick="requestNotificationPermission()">
          Enable Notifications
        </button>
      </div>

      <div class="main-grid">
        <div class="sidebar">
          <div class="add-task-form">
            <h2 style="color: #2d3748; margin-bottom: 20px">Add New Task</h2>
            <div class="form-group">
              <label for="taskName">Task Name</label>
              <input
                type="text"
                id="taskName"
                placeholder="e.g., Complete project proposal"
              />
            </div>
            <div class="form-group">
              <label for="deadline">Deadline</label>
              <input type="datetime-local" id="deadline" />
            </div>
            <div class="form-group">
              <label for="daysRequired">Days Required</label>
              <input type="number" id="daysRequired" min="1" value="1" />
            </div>
            <div class="form-group">
              <label for="dailyHours">Daily Hours</label>
              <input
                type="number"
                id="dailyHours"
                min="0.5"
                step="0.5"
                value="2"
              />
            </div>
            <button class="btn" onclick="addTask()">Add Task</button>
          </div>

          <div class="ai-suggestions" id="aiSuggestions">
            <h3>ü§ñ AI Suggestions</h3>
            <div id="suggestionsList"></div>
          </div>

          <div class="task-list">
            <h3 style="color: #2d3748; margin-bottom: 15px">Active Tasks</h3>
            <div id="taskList"></div>
          </div>
        </div>

        <div class="calendar-section">
          <div class="calendar-header">
            <h2 style="color: #2d3748">Week View</h2>
            <div>
              <span id="currentWeek" style="color: #718096"></span>
            </div>
          </div>
          <div class="week-view" id="weekView">
            <!-- Calendar will be generated here -->
          </div>
        </div>
      </div>

      <div class="stats-panel">
        <h3 style="color: #2d3748">Productivity Stats</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="tasksCompleted">0</div>
            <div class="stat-label">Tasks Completed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="focusTime">0h</div>
            <div class="stat-label">Focus Time Today</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="streakDays">0</div>
            <div class="stat-label">Day Streak</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="completionRate">0%</div>
            <div class="stat-label">Completion Rate</div>
          </div>
        </div>
      </div>
    </div>

    <div class="notification" id="notification">
      <div class="notification-header" id="notificationHeader">
        Task Reminder
      </div>
      <div class="notification-body" id="notificationBody">
        It's time for your scheduled task
      </div>
      <div class="notification-actions">
        <button
          class="notification-btn accept"
          onclick="handleNotification('accept')"
        >
          Start
        </button>
        <button
          class="notification-btn reschedule"
          onclick="handleNotification('reschedule')"
        >
          Reschedule
        </button>
        <button
          class="notification-btn decline"
          onclick="handleNotification('decline')"
        >
          Skip
        </button>
      </div>
    </div>

    <div class="pomodoro-timer" id="pomodoroTimer" style="display: none">
      <div class="timer-display" id="timerDisplay">25:00</div>
      <div class="timer-label" id="timerLabel">Focus Time</div>
      <div class="timer-controls">
        <button
          class="timer-btn pause"
          id="pauseBtn"
          onclick="togglePauseResume()"
        >
          ‚è∏ Pause
        </button>
        <button class="timer-btn stop" onclick="stopPomodoro()">‚èπ Stop</button>
      </div>
    </div>

    <div class="google-cal-section" id="googleCalSection" style="display: none">
      <h3 style="color: #2d3748; margin-bottom: 15px">
        Google Calendar Integration
        <span
          id="authStatus"
          style="font-size: 0.8em; color: #48bb78; margin-left: 10px"
        ></span>
      </h3>
      <button class="google-btn" id="connectBtn" onclick="initiateGoogleAuth()">
        Connect Google Calendar
      </button>
      <div id="calendarEvents" style="margin-top: 15px"></div>
    </div>

    <script>
      const DISCOVERY_DOCS = [
        "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
      ];
      // State Management
      let tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      let schedule = JSON.parse(localStorage.getItem("schedule") || "[]");
      let currentTask = null;
      let pomodoroInterval = null;
      let pomodoroTimeLeft = 25 * 60;
      let pomodoroPaused = false;
      let stats = JSON.parse(
        localStorage.getItem("stats") ||
          '{"completed": 0, "focusTime": 0, "streak": 0, "totalTasks": 0}'
      );

      // Google Calendar API configuration
      const GOOGLE_CLIENT_ID = "{{ google_client_id or '' }}";
      const GOOGLE_API_KEY = "{{ calendar_api_key or '' }}";
      const SCOPES = "{{ google_scopes or '' }}";

      let domReady = false;
      window.gapiLoaded = window.gapiLoaded || false;
      let calendarApiLoaded = false;

      // Initialize the app
      function init() {
        setDefaultDeadline();
        renderTasks();
        renderCalendar();
        updateStats();
        startNotificationChecker();
        generateAISuggestions();

        fetch("/check_auth")
          .then((r) => r.json())
          .then((data) => {
            document.getElementById("googleCalSection").style.display = "block";
            if (data.authenticated) {
              document.getElementById("connectBtn").textContent = "Connected";
              document.getElementById("connectBtn").disabled = true;
              document.getElementById("authStatus").textContent =
                "Authenticated";
              loadGoogleAPI();
              setTimeout(authenticateGapiWithFlaskToken, 1000);
            }
          });
      }
      // function authenticateGapiWithFlaskToken() {
      //   if (!gapi.auth2 || !gapi.auth2.getAuthInstance()) {
      //     setTimeout(authenticateGapiWithFlaskToken, 500);
      //     return;
      //   }
      //   fetch("/get_gapi_token")
      //     .then((r) => r.json())
      //     .then((tokenData) => {
      //       const authInstance = gapi.auth2.getAuthInstance();
      //       const user = authInstance.currentUser.get();
      //       user.reloadAuthResponse().then(() => {
      //         user.setAuthResponse({
      //           access_token: tokenData.access_token,
      //           expires_in: tokenData.expires_in,
      //           scope: tokenData.scope,
      //         });
      //         updateSigninStatus(true);
      //       });
      //     });
      // }
      // Set default deadline to tomorrow
      function setDefaultDeadline() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 7);
        document.getElementById("deadline").value = tomorrow
          .toISOString()
          .slice(0, 16);
      }

      // Add a new task
      function addTask() {
        const name = document.getElementById("taskName").value;
        const deadline = document.getElementById("deadline").value;
        const daysRequired = parseInt(
          document.getElementById("daysRequired").value
        );
        const dailyHours = parseFloat(
          document.getElementById("dailyHours").value
        );

        if (!name || !deadline) {
          alert("Please fill in task name and deadline");
          return;
        }

        const task = {
          id: Date.now(),
          name,
          deadline: new Date(deadline),
          daysRequired,
          dailyHours,
          totalHours: daysRequired * dailyHours,
          completedHours: 0,
          status: "pending",
          priority: calculatePriority(
            new Date(deadline),
            daysRequired * dailyHours
          ),
          createdAt: new Date(),
        };

        tasks.push(task);
        saveTasks();

        // AI Schedule Generation
        generateSchedule(task);

        // Clear form
        document.getElementById("taskName").value = "";
        document.getElementById("daysRequired").value = "1";
        document.getElementById("dailyHours").value = "2";
        setDefaultDeadline();

        renderTasks();
        renderCalendar();
        generateAISuggestions();

        stats.totalTasks++;
        updateStats();
      }

      // Calculate task priority based on deadline and time required
      function calculatePriority(deadline, totalHours) {
        const now = new Date();
        const hoursUntilDeadline = (deadline - now) / (1000 * 60 * 60);
        const urgency = totalHours / hoursUntilDeadline;
        return Math.min(10, Math.max(1, Math.round(urgency * 10)));
      }

      // AI-powered schedule generation
      function generateSchedule(task) {
        const now = new Date();
        const deadline = new Date(task.deadline);
        const sessions = Math.ceil(task.totalHours * 2); // 30-min sessions

        let currentDate = new Date(now);
        currentDate.setHours(currentDate.getHours() + 1);
        currentDate.setMinutes(0);

        const preferredTimes = [
          { start: 9, end: 11, productivity: 1.2 }, // Morning focus
          { start: 14, end: 16, productivity: 1.0 }, // Afternoon
          { start: 19, end: 21, productivity: 0.8 }, // Evening
        ];

        let sessionsScheduled = 0;

        while (sessionsScheduled < sessions && currentDate < deadline) {
          const hour = currentDate.getHours();
          const dayOfWeek = currentDate.getDay();

          // Skip weekends for work tasks (configurable)
          if (dayOfWeek === 0 || dayOfWeek === 6) {
            currentDate.setDate(currentDate.getDate() + 1);
            currentDate.setHours(9, 0, 0, 0);
            continue;
          }

          // Find if current hour is in preferred time
          const timeSlot = preferredTimes.find(
            (t) => hour >= t.start && hour < t.end
          );

          if (timeSlot) {
            const scheduleItem = {
              id: Date.now() + sessionsScheduled,
              taskId: task.id,
              taskName: task.name,
              start: new Date(currentDate),
              end: new Date(currentDate.getTime() + 30 * 60000), // 30 minutes
              type: "pomodoro",
              status: "scheduled",
              productivity: timeSlot.productivity,
            };

            schedule.push(scheduleItem);
            sessionsScheduled++;

            // Move to next 30-min slot
            currentDate.setMinutes(currentDate.getMinutes() + 30);
          } else {
            // Move to next hour
            currentDate.setHours(currentDate.getHours() + 1);
          }

          // If end of day, move to next day
          if (hour >= 21) {
            currentDate.setDate(currentDate.getDate() + 1);
            currentDate.setHours(9, 0, 0, 0);
          }
        }

        // Add deadline marker to schedule
        schedule.push({
          id: Date.now() + 999999,
          taskId: task.id,
          taskName: task.name + " (DEADLINE)",
          start: deadline,
          end: deadline,
          type: "deadline",
          status: "deadline",
        });

        saveSchedule();
      }

      // Generate AI suggestions for optimal work times
      function generateAISuggestions() {
        const suggestions = [];
        const now = new Date();
        const hour = now.getHours();

        // Analyze user patterns (simulated)
        const productivityScore = {
          morning: 0.9,
          afternoon: 0.7,
          evening: 0.6,
        };

        // Get high-priority tasks
        const urgentTasks = tasks
          .filter((t) => t.status !== "completed")
          .sort((a, b) => b.priority - a.priority)
          .slice(0, 3);

        urgentTasks.forEach((task) => {
          let suggestedTime = "";
          if (hour < 12 && productivityScore.morning > 0.8) {
            suggestedTime = "Now (High energy morning slot)";
          } else if (hour < 17) {
            suggestedTime = "This afternoon (2-4 PM)";
          } else {
            suggestedTime = "Tomorrow morning (9-11 AM)";
          }

          suggestions.push({
            task: task.name,
            time: suggestedTime,
            reason: `Priority: ${task.priority}/10`,
            taskId: task.id,
          });
        });

        renderAISuggestions(suggestions);
      }

      // Render AI suggestions
      function renderAISuggestions(suggestions) {
        const container = document.getElementById("suggestionsList");

        if (suggestions.length === 0) {
          container.innerHTML =
            '<p style="color: #718096; font-size: 0.9em;">No urgent tasks. Great job!</p>';
          return;
        }

        container.innerHTML = suggestions
          .map(
            (s) => `
                <div class="suggestion-item" onclick="acceptSuggestion(${s.taskId})">
                    <strong>${s.task}</strong><br>
                    <small style="color: #718096;">${s.time} ‚Ä¢ ${s.reason}</small>
                </div>
            `
          )
          .join("");
      }

      // Accept AI suggestion and start task
      function acceptSuggestion(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (task) {
          startPomodoro(task);
        }
      }

      // Start Pomodoro timer
      function startPomodoro(task) {
        currentTask = task;
        pomodoroTimeLeft = 25 * 60; // Reset to 25 minutes
        pomodoroPaused = false;

        document.getElementById("pomodoroTimer").style.display = "flex";
        document.getElementById(
          "timerLabel"
        ).textContent = `Working on: ${task.name}`;
        document.getElementById("pauseBtn").textContent = "‚è∏ Pause";
        document.getElementById("pauseBtn").className = "timer-btn pause";

        clearInterval(pomodoroInterval);
        pomodoroInterval = setInterval(() => {
          if (!pomodoroPaused) {
            pomodoroTimeLeft--;

            const minutes = Math.floor(pomodoroTimeLeft / 60);
            const seconds = pomodoroTimeLeft % 60;
            document.getElementById("timerDisplay").textContent = `${minutes
              .toString()
              .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

            if (pomodoroTimeLeft <= 0) {
              clearInterval(pomodoroInterval);
              handlePomodoroComplete();
            }

            // 20-minute check-in (5 minutes remaining)
            if (pomodoroTimeLeft === 5 * 60) {
              showNotification(
                "Check-in",
                "Are you still working on: " + task.name + "?"
              );
            }
          }
        }, 1000);

        showNotification("Task Started", `Working on: ${task.name}`);
      }

      // Toggle pause/resume
      function togglePauseResume() {
        pomodoroPaused = !pomodoroPaused;
        const btn = document.getElementById("pauseBtn");

        if (pomodoroPaused) {
          btn.textContent = "‚ñ∂ Resume";
          btn.className = "timer-btn resume";
          showNotification(
            "Timer Paused",
            "Take a break. Click Resume when ready."
          );
        } else {
          btn.textContent = "‚è∏ Pause";
          btn.className = "timer-btn pause";
          showNotification("Timer Resumed", "Back to work!");
        }
      }

      // Stop Pomodoro timer
      function stopPomodoro() {
        clearInterval(pomodoroInterval);
        document.getElementById("pomodoroTimer").style.display = "none";

        if (currentTask) {
          // Calculate partial progress
          const minutesWorked = (25 * 60 - pomodoroTimeLeft) / 60;
          const hoursWorked = minutesWorked / 60;
          currentTask.completedHours += hoursWorked;

          stats.focusTime += hoursWorked;
          saveTasks();
          updateStats();
          renderTasks();

          showNotification(
            "Session Stopped",
            `Logged ${minutesWorked.toFixed(0)} minutes of work`
          );
        }

        currentTask = null;
        pomodoroPaused = false;
      }

      // Handle Pomodoro completion
      function handlePomodoroComplete() {
        if (currentTask) {
          currentTask.completedHours += 0.5;

          // Check if task is complete
          if (currentTask.completedHours >= currentTask.totalHours) {
            currentTask.status = "completed";
            stats.completed++;
            showNotification(
              "Task Completed! üéâ",
              `Great job on: ${currentTask.name}`
            );
          } else {
            const remaining =
              currentTask.totalHours - currentTask.completedHours;
            showNotification(
              "Session Complete",
              `${remaining.toFixed(1)} hours remaining for: ${currentTask.name}`
            );
          }

          stats.focusTime += 0.5;
          saveTasks();
          updateStats();
          renderTasks();
          renderCalendar();
        }

        document.getElementById("pomodoroTimer").style.display = "none";
        currentTask = null;
        pomodoroPaused = false;
      }

      // Render tasks list
      function renderTasks() {
        const container = document.getElementById("taskList");
        const activeTasks = tasks.filter((t) => t.status !== "completed");

        if (activeTasks.length === 0) {
          container.innerHTML =
            '<p style="color: #718096;">No active tasks</p>';
          return;
        }

        container.innerHTML = activeTasks
          .map((task) => {
            const progress = (task.completedHours / task.totalHours) * 100;
            const daysLeft = Math.ceil(
              (task.deadline - new Date()) / (1000 * 60 * 60 * 24)
            );

            return `
                    <div class="task-item">
                        <div class="task-header">
                            <span class="task-name">${task.name}</span>
                            <span class="task-deadline" style="color: ${
                              daysLeft <= 1 ? "#e53e3e" : "#718096"
                            }">
                                ${daysLeft} days left
                            </span>
                        </div>
                        <div class="task-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <span style="font-size: 12px; color: #718096;">${Math.round(
                              progress
                            )}%</span>
                        </div>
                        <div style="margin-top: 8px;">
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" 
                                    onclick='startPomodoro(${JSON.stringify(
                                      task
                                    ).replace(/'/g, "&apos;")})'>
                                Start Session
                            </button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // Render calendar with deadlines
      function renderCalendar() {
        const container = document.getElementById("weekView");
        const now = new Date();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - now.getDay());
        startOfWeek.setHours(0, 0, 0, 0);

        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const hours = Array.from({ length: 13 }, (_, i) => i + 8); // 8 AM to 8 PM

        // Header row
        let html = "<div></div>"; // Empty corner
        days.forEach((day, i) => {
          const date = new Date(startOfWeek);
          date.setDate(startOfWeek.getDate() + i);
          const isToday = date.toDateString() === now.toDateString();
          html += `<div class="day-header" style="${
            isToday ? "background: #e6fffa;" : ""
          }">
                    ${day}<br><small>${date.getDate()}</small>
                </div>`;
        });

        // Time slots
        hours.forEach((hour) => {
          html += `<div class="time-label">${hour}:00</div>`;

          days.forEach((_, dayIndex) => {
            const slotDate = new Date(startOfWeek);
            slotDate.setDate(startOfWeek.getDate() + dayIndex);
            slotDate.setHours(hour, 0, 0, 0);

            const scheduledItems = schedule.filter((s) => {
              const sDate = new Date(s.start);
              return (
                sDate.getHours() === hour &&
                sDate.toDateString() === slotDate.toDateString() &&
                s.type !== "deadline"
              );
            });

            // Check for deadlines on this day
            const deadlines = tasks.filter((t) => {
              const deadline = new Date(t.deadline);
              return (
                deadline.toDateString() === slotDate.toDateString() &&
                deadline.getHours() === hour
              );
            });

            html +=
              '<div class="day-column time-slot" style="position: relative;">';

            // Render scheduled tasks
            scheduledItems.forEach((item) => {
              const statusClass =
                item.status === "completed"
                  ? "completed"
                  : item.status === "in-progress"
                  ? "in-progress"
                  : "";
              const isExternal = item.source === "google";
              const clickHandler = isExternal
                ? ""
                : `onclick="handleScheduleClick(${item.id})"`;
              html += `
                            <div class="scheduled-task ${statusClass}${
                isExternal ? " external-event" : ""
              }" ${clickHandler}>
                                ${item.taskName}
                            </div>
                        `;
            });

            // Render deadline indicators
            deadlines.forEach((task) => {
              const leftPosition =
                (task.deadline.getMinutes() / 60) * 100 + "%";
              html += `
                            <div class="deadline-indicator" style="left: ${leftPosition};">
                                <div class="deadline-label">üìç ${task.name}</div>
                            </div>
                        `;
            });

            html += "</div>";
          });
        });

        container.innerHTML = html;

        // Update week display
        const weekEnd = new Date(startOfWeek);
        weekEnd.setDate(startOfWeek.getDate() + 6);
        document.getElementById(
          "currentWeek"
        ).textContent = `${startOfWeek.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
      }

      // Handle click on scheduled item
      function handleScheduleClick(scheduleId) {
        const item = schedule.find((s) => s.id === scheduleId);
        if (item && item.status === "scheduled") {
          const task = tasks.find((t) => t.id === item.taskId);
          if (task) {
            startPomodoro(task);
            item.status = "in-progress";
            saveSchedule();
            renderCalendar();
          }
        }
      }

      // Google Calendar Integration
      function loadGoogleAPI() {
        if (typeof gapi === "undefined" || !gapi.load) {
          setTimeout(loadGoogleAPI, 100);
          return;
        }
        gapi.load("client:auth2", initGoogleClient);
      }

      function initGoogleClient() {
        gapi.load("client", () => {
          gapi.client
            .init({
              apiKey: GOOGLE_API_KEY,
              discoveryDocs: DISCOVERY_DOCS,
            })
            .then(() => authenticateGapiWithFlaskToken());
        });
      }

      function authenticateGapiWithFlaskToken() {
        if (!gapi.client || !gapi.client.setToken) {
          setTimeout(authenticateGapiWithFlaskToken, 500);
          return;
        }
        fetch("/get_gapi_token")
          .then((r) => r.json())
          .then((tokenData) => {
            gapi.client.setToken({ access_token: tokenData.access_token });
            ensureCalendarApiLoaded()
              .then(() => updateSigninStatus(true))
              .catch((error) => {
                console.error("Failed to load Google Calendar API", error);
              });
          });
      }

      function updateSigninStatus(isSignedIn) {
        if (isSignedIn && gapi.client.getToken()) {
          ensureCalendarApiLoaded()
            .then(() => loadCalendarEvents())
            .catch((error) => {
              console.error("Google Calendar API not ready", error);
            });
        }
      }

      function ensureCalendarApiLoaded() {
        if (calendarApiLoaded) {
          return Promise.resolve();
        }
        if (!gapi.client || !gapi.client.load) {
          return Promise.reject(new Error("gapi client not ready"));
        }
        return gapi.client.load("calendar", "v3").then(() => {
          calendarApiLoaded = true;
        });
      }

      //function initiateGoogleAuth() {
      //  gapi.auth2.getAuthInstance().signIn();
      //}

      function initiateGoogleAuth() {
        // Use Flask OAuth instead of gapi
        window.location.href = "/auth";
      }

      function loadCalendarEvents() {
        gapi.client.calendar.events
          .list({
            calendarId: "primary",
            timeMin: new Date().toISOString(),
            showDeleted: false,
            singleEvents: true,
            maxResults: 10,
            orderBy: "startTime",
          })
          .then((response) => {
            const events = response.result.items;
            displayGoogleEvents(events);
            extractDeadlinesFromEvents(events);
            mergeGoogleEventsIntoSchedule(events);
          });
      }

      function displayGoogleEvents(events) {
        const container = document.getElementById("calendarEvents");
        if (events.length > 0) {
          container.innerHTML = "<h4>Upcoming Google Calendar Events:</h4>";
          events.forEach((event) => {
            const when = event.start.dateTime || event.start.date;
            container.innerHTML += `
                        <div style="padding: 8px; background: #f7fafc; margin: 5px 0; border-radius: 6px;">
                            <strong>${event.summary}</strong><br>
                            <small>${new Date(when).toLocaleString()}</small>
                            ${
                              event.description &&
                              event.description.includes("deadline")
                                ? `<button onclick="importAsTask('${event.summary}', '${when}')" 
                                 style="margin-left: 10px; padding: 2px 8px; background: #667eea; 
                                 color: white; border: none; border-radius: 4px; cursor: pointer;">
                                 Import as Task
                                </button>`
                                : ""
                            }
                        </div>
                    `;
          });
        } else {
          container.innerHTML = "<p>No upcoming events found.</p>";
        }
      }

      function extractDeadlinesFromEvents(events) {
        events.forEach((event) => {
          // Check if event title or description contains deadline keywords
          const deadlineKeywords = [
            "deadline",
            "due",
            "submit",
            "delivery",
            "final",
          ];
          const hasDeadline = deadlineKeywords.some(
            (keyword) =>
              (event.summary &&
                event.summary.toLowerCase().includes(keyword)) ||
              (event.description &&
                event.description.toLowerCase().includes(keyword))
          );

          if (hasDeadline) {
            console.log("Found potential deadline:", event.summary);
            // Auto-suggest as task
            showNotification(
              "Deadline Detected",
              `Found deadline in calendar: "${event.summary}". Click to import.`
            );
          }
        });
      }

      function mergeGoogleEventsIntoSchedule(events) {
        if (!Array.isArray(events)) {
          return;
        }

        const normalizedEvents = events.filter(
          (event) => event && event.id && event.start
        );
        const incomingIds = new Set(normalizedEvents.map((event) => event.id));

        schedule = schedule.filter((item) => {
          if (item && item.source === "google" && item.externalId) {
            return incomingIds.has(item.externalId);
          }
          return true;
        });

        normalizedEvents.forEach((event) => {
          const alreadySynced = schedule.some(
            (item) => item.source === "google" && item.externalId === event.id
          );
          if (alreadySynced) {
            return;
          }

          const startIso =
            event.start.dateTime ||
            (event.start.date ? `${event.start.date}T09:00:00` : null);
          if (!startIso) {
            return;
          }

          const endIso =
            event.end?.dateTime ||
            (event.end?.date ? `${event.end.date}T17:00:00` : null);

          const startDate = new Date(startIso);
          const endDate = endIso
            ? new Date(endIso)
            : new Date(startDate.getTime() + 60 * 60 * 1000);

          schedule.push({
            id: Date.now() + Math.floor(Math.random() * 1000),
            externalId: event.id,
            source: "google",
            taskId: null,
            taskName: `${event.summary || "Google Event"}`,
            start: startDate,
            end: endDate,
            type: "external",
            status: "scheduled",
            location: event.location || "",
          });
        });

        saveSchedule();
        renderCalendar();
      }

      function importAsTask(eventName, eventTime) {
        document.getElementById("taskName").value = eventName;
        document.getElementById("deadline").value = new Date(eventTime)
          .toISOString()
          .slice(0, 16);
        showNotification(
          "Task Imported",
          "Deadline imported from Google Calendar. Adjust hours and add task."
        );
      }

      // Show notification
      function showNotification(title, body) {
        const notification = document.getElementById("notification");
        document.getElementById("notificationHeader").textContent = title;
        document.getElementById("notificationBody").textContent = body;
        notification.classList.add("show");

        // Auto-hide after 5 seconds
        setTimeout(() => {
          notification.classList.remove("show");
        }, 5000);

        // Browser notification if permitted
        if (Notification.permission === "granted") {
          new Notification(title, { body, icon: "üéØ" });
        }
      }

      // Handle notification actions
      function handleNotification(action) {
        const notification = document.getElementById("notification");
        notification.classList.remove("show");

        if (action === "accept" && currentTask) {
          // Continue with current task
        } else if (action === "reschedule") {
          // Move to next available slot
          generateAISuggestions();
        } else if (action === "decline") {
          // Track reason (simplified for MVP)
          const reasons = [
            "Too tired",
            "Emergency came up",
            "Need a break",
            "Other priority",
          ];
          const reason = reasons[Math.floor(Math.random() * reasons.length)];
          console.log("Task declined:", reason);
        }
      }

      // Check for upcoming scheduled tasks
      function startNotificationChecker() {
        setInterval(() => {
          const now = new Date();
          const upcoming = schedule.filter((s) => {
            const startTime = new Date(s.start);
            const timeDiff = (startTime - now) / (1000 * 60); // minutes
            return timeDiff > 0 && timeDiff <= 5 && s.status === "scheduled";
          });

          if (upcoming.length > 0) {
            const next = upcoming[0];
            showNotification(
              "Upcoming Task",
              `"${next.taskName}" starts in 5 minutes. Get ready!`
            );
          }

          // Check for missed deadlines
          tasks.forEach((task) => {
            if (task.status !== "completed") {
              const hoursUntilDeadline =
                (task.deadline - now) / (1000 * 60 * 60);
              if (hoursUntilDeadline > 0 && hoursUntilDeadline <= 1) {
                showNotification(
                  "‚ö†Ô∏è Deadline Alert",
                  `"${task.name}" deadline in ${Math.round(
                    hoursUntilDeadline * 60
                  )} minutes!`
                );
              }
            }
          });
        }, 60000); // Check every minute
      }

      // Update statistics
      function updateStats() {
        document.getElementById("tasksCompleted").textContent = stats.completed;
        document.getElementById(
          "focusTime"
        ).textContent = `${stats.focusTime.toFixed(1)}h`;
        document.getElementById("streakDays").textContent = stats.streak;

        const completionRate =
          stats.totalTasks > 0
            ? Math.round((stats.completed / stats.totalTasks) * 100)
            : 0;
        document.getElementById(
          "completionRate"
        ).textContent = `${completionRate}%`;

        localStorage.setItem("stats", JSON.stringify(stats));
      }

      // Save functions
      function saveTasks() {
        localStorage.setItem("tasks", JSON.stringify(tasks));
      }

      function saveSchedule() {
        localStorage.setItem("schedule", JSON.stringify(schedule));
      }

      // // Request notification permission
      // if ("Notification" in window && Notification.permission === "default") {
      //   // Notification.requestPermission();
      // }

      function requestNotificationPermission() {
        Notification.requestPermission().then((perm) => {
          if (perm === "granted") alert("Notifications enabled!");
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        domReady = true;
        window.domReady = true;
        if (window.gapiLoaded) {
          init();
        }
      });

      setTimeout(() => {
        if (!window.gapiLoaded && typeof gapi !== "undefined") {
          window.gapiLoaded = true;
          if (domReady) {
            init();
          }
        }
      }, 3000);
      console.log("page ready ‚Äì gapi loaded:", !!window.gapi);
    </script>
  </body>
</html>
